# Jinjiu 项目规划（MMO 场景识别 + 自动打怪）

## 1. 产品定位
Jinjiu 的本质是一个 **MMO 自动作战辅助系统**：
- 通过屏幕理解识别当前游戏状态
- 生成行为决策（找怪、接敌、输出、保命、拾取）
- 将决策转为可控的输入动作（键鼠）
- 保留“人工接管”和“安全刹车”能力

> 核心原则：先稳定识别，再有限自动化，最后才追求高效率。

---

## 2. 总体架构

1. **Capture（采集层）**
   - 屏幕帧抓取（已完成基础版）
   - 时间戳、帧率、分辨率统一

2. **Perception（感知层）**
   - UI 状态识别（血量、蓝量、技能CD、目标条、背包满、死亡、复活）
   - 战斗目标识别（目标存在、距离、是否可攻击）
   - OCR（任务、提示、异常弹窗）

3. **State（状态机层）**
   - 将感知结果映射为有限状态：
     - `IDLE` / `SEARCH` / `ENGAGE` / `COMBAT` / `LOOT` / `RECOVER` / `ESCAPE` / `ERROR`

4. **Policy（策略层）**
   - 按职业/流派执行战斗轮换
   - 保命优先级高于输出
   - 决策节流、去抖、超时回退

5. **Action（执行层）**
   - 键鼠操作下发（含随机微扰与冷却控制）
   - 行为日志与回放

6. **Guard（安全层）**
   - 前台窗口校验（仅在目标游戏窗口执行）
   - 紧急停止热键
   - 异常检测（卡死、反复死亡、无收益空转）

---

## 3. 当前实现状态
- ✅ Phase 1：屏幕采集模块（Jinjiu.Capture）
- ✅ Phase 2（基础）：基于亮度/帧差的规则事件（Jinjiu.Orchestrator）
- ⏳ 下一步：把“规则事件”升级为“MMO 可用状态识别 + 战斗状态机”

---

## 4. MMO 优化后的开发里程碑

### M1（已完成）采集层可用
- 连续截图
- 元信息日志

### M2（进行中）基础感知层
- 关键区域 ROI 配置（血条、技能栏、目标条、小地图）
- OCR 接入
- 模板匹配/颜色阈值提取核心数值

### M3 状态机
- 引入有限状态机（FSM）
- 解决“识别抖动 -> 动作抖动”问题
- 状态切换日志

### M4 自动作战执行
- 动作队列 + CD 管理
- 简单轮换（起手/循环/斩杀）
- 保命规则（血量阈值喝药/脱战）

### M5 稳定性与风控
- 卡死恢复
- 死亡恢复路径
- 长时间收益监控（空转报警）
- 行为节流与人工接管

---

## 5. 关键设计优化点

### 5.1 不做“全屏理解”，先做 ROI
先锁定固定 UI 区域，降低计算量并提升准确率：
- 玩家血蓝区
- 当前目标血条区
- 技能栏CD区
- 弹窗提示区

### 5.2 决策不要直接接感知，必须经过状态机
感知有噪声，动作必须稳定：
- 连续 N 帧确认后再切状态
- 切状态设最短保持时长（dwell time）

### 5.3 操作执行要“可解释”
每次动作记录：
- 触发原因（哪个识别结果）
- 当前状态
- 动作内容
- 冷却与限流信息

### 5.4 先做“半自动”，再做“全自动”
推荐阶段：
1) 仅提示（建议动作）
2) 一键确认执行
3) 条件自动执行

---

## 6. 文档约定
本项目所有规划和设计文档统一放在 `jinjiu/docs/`。
当前核心文档：
- `PROJECT_PLAN.md`（总览）
- `MMO_AUTOFARM_ARCHITECTURE.md`（详细架构）
- `PHASE_1_CAPTURE.md`
- `PHASE_2_RULE_ENGINE.md`
- `COMMAND_PROTOCOL.md`

---

## 7. 下一阶段交付（建议）
1. 新增 `ROI_CONFIG.md`：定义各 UI 区域坐标和缩放策略
2. 新增 `FSM_DESIGN.md`：状态、转移条件、超时回退
3. 在 Orchestrator 中增加 `game_state.json` 输出（每秒）
4. 把动作从“文本指令”升级为 `action_queue.jsonl` 结构化队列
